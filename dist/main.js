#!/usr/bin/env bun
import {cli}from'@minejs/cli';import*as g from'fs';import*as T from'path';import {input,select,confirm}from'@inquirer/prompts';import {spawnSync}from'child_process';var B=Object.defineProperty;var N=(u=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(u,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):u)(function(u){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+u+'" is not supported')});var K=(u,e)=>()=>(u&&(e=u(u=0)),e);var W=(u,e)=>{for(var t in e)B(u,t,{get:e[t],enumerable:true});};var q={};W(q,{TemplateRegistry:()=>b});var b,j=K(()=>{b=class{static{this.TEMPLATES={lib:{type:"lib",defaultTemplate:"clean",templates:[{name:"clean",label:"Clean Library",description:"Zero dependencies - just TypeScript and build tools",repo:"lib",requiresSetup:false,ready:true}]},server:{type:"server",defaultTemplate:"clean",templates:[{name:"clean",label:"Clean Server",description:"Comes with @minejs/server library for quick server development",repo:"server",deps:["@minejs/server"],requiresSetup:true,ready:true}]},cli:{type:"cli",defaultTemplate:"clean",templates:[{name:"clean",label:"Clean CLI",description:"Comes with @minejs/cli library for quick CLI development",repo:"cli",deps:["@minejs/cli"],requiresSetup:true,ready:true}]},app:{type:"app",defaultTemplate:"clean",templates:[{name:"clean",label:"Clean Web App",description:"Comes with @cruxjs framework for quick web development",repo:"app",deps:["@cruxjs/app"],requiresSetup:true,ready:true}]}};}static getTemplatesForType(e,t=false){let s=this.TEMPLATES[e]?.templates||[];return t?s:s.filter(r=>r.ready)}static getReadyTemplatesForType(e){return this.getTemplatesForType(e,false)}static getDefaultTemplate(e){let t=this.TEMPLATES[e];if(!t)return "clean";let s=t.templates.find(a=>a.name===t.defaultTemplate&&a.ready);return s?s.name:t.templates.find(a=>a.ready)?.name||t.defaultTemplate}static getTemplate(e,t){let s=this.TEMPLATES[e];return s?s.templates.find(r=>r.name===t):null}static isTemplateReady(e,t){return this.getTemplate(e,t)?.ready||false}static isValidTemplate(e,t){return this.getTemplatesForType(e).some(r=>r.name===t)}static getRepoName(e,t){return this.getTemplate(e,t)?.repo||"ready-lib"}static getSpaceTypes(){return Object.keys(this.TEMPLATES)}};});j();var R=["name","version","description","keywords","license","homepage","bugs","author","repository","type","main","types","bin","files","exports","scripts","engines","peerDependencies","dependencies","devDependencies"],J=["type","template","pm","repo","author","createdAt"];var P=class{static format(e,t={}){let s=t.indent||"	",r=t.alignColons!==false,a=t.sortKeys||false,i=t.tabWidth||4,n=t.keyOrder||[],m=r?this.calculateGlobalMaxKeyLength(e):0,p=this.calculateMaxDepth(e)*(s==="	"?i:s.length);return this.formatValue(e,0,s,r,a,m,p,i,n)}static formatFile(e,t={}){let s=g.readFileSync(e,"utf-8");s.charCodeAt(0)===65279&&(s=s.slice(1));let r=JSON.parse(s),a=this.format(r,t);g.writeFileSync(e,a+`
`,"utf-8");}static findJsonFiles(e){let t=[],s=r=>{if(!g.existsSync(r))return;g.readdirSync(r,{withFileTypes:true}).forEach(i=>{let n=T.join(r,i.name);i.name!=="node_modules"&&(i.isDirectory()?s(n):i.isFile()&&i.name.endsWith(".json")&&t.push(n));});};return s(e),t}static formatDirectory(e,t={}){let s={success:[],failed:[]};return this.findJsonFiles(e).forEach(a=>{try{this.formatFile(a,t),s.success.push(a);}catch(i){s.failed.push({file:a,error:i instanceof Error?i.message:String(i)});}}),s}static calculateMaxDepth(e,t=0){if(!e||typeof e!="object")return t;let s=t;return Array.isArray(e)?e.forEach(r=>{let a=this.calculateMaxDepth(r,t+1);a>s&&(s=a);}):Object.values(e).forEach(r=>{let a=this.calculateMaxDepth(r,t+1);a>s&&(s=a);}),s}static sortKeys(e,t,s){if(t.length===0)return s?e.sort():e;let r=[],a=[];return e.forEach(i=>{t.includes(i)?r.push(i):a.push(i);}),r.sort((i,n)=>t.indexOf(i)-t.indexOf(n)),s&&a.sort(),[...r,...a]}static calculateGlobalMaxKeyLength(e){let t=0,s=r=>{if(!r||typeof r!="object")return;if(Array.isArray(r)){r.forEach(i=>s(i));return}Object.keys(r).forEach(i=>{let n=JSON.stringify(i).length;n>t&&(t=n),s(r[i]);});};return s(e),t}static formatValue(e,t,s,r,a,i,n,m,h){if(e===null)return "null";if(e===void 0)return "undefined";let p=typeof e;return p==="string"?JSON.stringify(e):p==="number"||p==="boolean"?String(e):Array.isArray(e)?this.formatArray(e,t,s,r,a,i,n,m,h):p==="object"?this.formatObject(e,t,s,r,a,i,n,m,h):JSON.stringify(e)}static formatArray(e,t,s,r,a,i,n,m,h){if(e.length===0)return "[]";if(e.every(o=>typeof o=="string"||typeof o=="number"||typeof o=="boolean"||o===null)&&e.length<=3)return "["+e.map(o=>this.formatValue(o,t,s,r,a,i,n,m,h)).join(", ")+"]";let y=s.repeat(t+1);return `[
`+e.map(o=>y+this.formatValue(o,t+1,s,r,a,i,n,m,h)).join(`,
`)+`
`+s.repeat(t)+"]"}static formatObject(e,t,s,r,a,i,n,m,h){if(Object.keys(e).length===0)return "{}";let p=Object.keys(e);p=this.sortKeys(p,h,a);let y=s.repeat(t+1),k=(t+1)*(s==="	"?m:s.length);return `{
`+p.map(d=>{let c=JSON.stringify(d),f=this.formatValue(e[d],t+1,s,r,a,i,n,m,h),C=e[d]!==null&&typeof e[d]=="object"&&!Array.isArray(e[d]);if(r&&!C){let _=n-k,U=i-c.length,V=" ".repeat(_+U);return `${y}${c}${V} : ${f}`}else return `${y}${c}: ${f}`}).join(`,
`)+`
`+s.repeat(t)+"}"}};if(N.main===module){let u=process.argv[2]||process.cwd();T.isAbsolute(u)||(u=T.resolve(process.cwd(),u)),console.log(`\u{1F50D} Scanning for JSON files in: ${u}
`);let e=P.formatDirectory(u,{alignColons:true,sortKeys:false});e.success.length>0&&(console.log(`\u2705 Successfully formatted ${e.success.length} file(s):`),e.success.forEach(t=>{let s=T.relative(process.cwd(),t);console.log(`   - ${s}`);})),e.failed.length>0&&(console.log(`
\u274C Failed to format ${e.failed.length} file(s):`),e.failed.forEach(({file:t,error:s})=>{let r=T.relative(process.cwd(),t);console.log(`   - ${r}: ${s}`);})),e.success.length===0&&e.failed.length===0&&console.log("\u{1F4ED} No JSON files found.");}var F=class{constructor(e=process.cwd()){this.basePath=e;}async createSpace(e,t){let s=t||T.join(this.basePath,e.repo.name);if(g.existsSync(s))throw new Error(`Space path "${s}" already exists!`);let r=false;try{g.existsSync(s)||(g.mkdirSync(s,{recursive:!0}),r=!0),await this.cloneTemplate(e.type,s,e,e.template),this.createSpaceConfig(s,e);}catch(a){if(r&&g.existsSync(s))try{await this.safeDeleteDirectory(s);}catch{console.warn(`Warning: Could not clean up directory at "${s}"`);}throw a}}loadSpaceConfig(e){let t=e||this.basePath,s=T.join(t,".space");if(!g.existsSync(s))return null;let r=g.readFileSync(s,"utf-8");return JSON.parse(r)}isSpace(e){let t=e||this.basePath;return g.existsSync(T.join(t,".space"))}async cloneTemplate(e,t,s,r){let i=`https://github.com/hmm-repos/${b.getRepoName(e,r)}.git`;try{let{execSync:n}=await import('child_process');n(`git clone --quiet --depth 1 ${i} "${t}"`,{stdio:"pipe"});let m=T.join(t,".git");g.existsSync(m)&&await this.safeDeleteDirectory(m),await this.updateTemplateFiles(t,s);}catch(n){throw n instanceof Error?n.message&&n.message.includes("Repository not found")?new Error(`Template repository not found: ${i}
This template is not yet available. Please mark it as ready: false in templateRegistry.ts`):new Error(`Failed to clone template from ${i}: ${n.message||n}`):new Error(`Failed to clone template from ${i}: ${n}`)}}async updateTemplateFiles(e,t){let s=t.repo.org&&t.repo.org.trim()!=="",r=t.author.id&&t.author.id.trim()!=="",a=s?t.repo.org:r?t.author.id:"",i=a?`git+https://github.com/${a}/${t.repo.name}.git`:"",n=a?`https://github.com/${a}/${t.repo.name}#readme`:"",m=a?`https://github.com/${a}/${t.repo.name}/issues`:"",h=s?`@${t.repo.org}/${t.repo.name}`:t.repo.name,p="\u{1F525}-";s?p+=`@${(t.repo.org.replace(/-/g,"--")+"/"+t.repo.name.replace(/-/g,"--")).replace(/ /g,"_")}`:t.author.name?p+=(t.author.name.replace(/-/g,"--")+"/"+t.repo.name.replace(/-/g,"--")).replace(/ /g,"_"):p+=t.repo.name.replace(/-/g,"--").replace(/ /g,"_");let y=r?`https://github.com/${t.author.id}`:t.author.url||"",k=this.getAllFiles(e);for(let o of k)if(!(o.includes("node_modules")||o.includes(".git")))try{let d=g.readFileSync(o,"utf-8");if(d.includes("{{")&&(d=d.replace(/\{\{tag\}\}/g,h).replace(/\{\{tag-badge\}\}/g,p).replace(/\{\{name\}\}/g,t.repo.name).replace(/\{\{repo\}\}/g,t.repo.name).replace(/\{\{org\}\}/g,t.repo.org||"").replace(/\{\{desc\}\}/g,t.repo.desc||`A ${t.type} space`).replace(/\{\{description\}\}/g,t.repo.desc||`A ${t.type} space`).replace(/\{\{version\}\}/g,t.repo.version).replace(/\{\{license\}\}/g,t.repo.license||"MIT").replace(/\{\{url\}\}/g,i).replace(/\{\{repo_url\}\}/g,i).replace(/\{\{git_url\}\}/g,i).replace(/\{\{homepage\}\}/g,n).replace(/\{\{issues\}\}/g,m).replace(/\{\{type\}\}/g,t.type).replace(/\{\{template\}\}/g,t.template||"clean").replace(/\{\{pm\}\}/g,t.pm).replace(/\{\{author\}\}/g,t.author.name||"").replace(/\{\{author_name\}\}/g,t.author.name||"").replace(/\{\{author_id\}\}/g,t.author.id||"").replace(/\{\{author_email\}\}/g,t.author.email||"").replace(/\{\{author_url\}\}/g,y),g.writeFileSync(o,d,"utf-8")),o.endsWith("package.json")){let c=JSON.parse(d);if(c.name=h,c.version=t.repo.version,c.description=t.repo.desc||`A ${t.type} space`,c.license=t.repo.license||"MIT",t.repo.kw&&t.repo.kw.length>0?c.keywords=t.repo.kw:c.keywords=[],n&&(c.homepage=n),m&&(c.bugs||(c.bugs={}),c.bugs.url=m),t.author.name&&(t.author.email?c.author={name:t.author.name,email:t.author.email,url:y||void 0}:c.author={name:t.author.name,url:y||void 0}),i&&(c.repository={type:"git",url:i}),t.type==="cli"&&c.bin){let f=Object.keys(c.bin)[0],C=c.bin[f];delete c.bin[f],c.bin[t.repo.name]=C;}c.engines||(c.engines={}),c.engines.bun||(c.engines.bun=">=1.0.0"),d=P.format(c,{keyOrder:R}),g.writeFileSync(o,d+`
`,"utf-8");continue}}catch{continue}}getAllFiles(e,t=[]){return g.readdirSync(e).forEach(r=>{let a=T.join(e,r);g.statSync(a).isDirectory()?t=this.getAllFiles(a,t):t.push(a);}),t}createSpaceConfig(e,t){let s=T.join(e,".space"),r=t.repo.org&&t.repo.org.trim()!=="",a=t.author.id&&t.author.id.trim()!=="",i=r?t.repo.org:a?t.author.id:"",n=i?`git+https://github.com/${i}/${t.repo.name}.git`:"",m=i?`https://github.com/${i}/${t.repo.name}#readme`:"",h=i?`https://github.com/${i}/${t.repo.name}/issues`:"",p=a?`https://github.com/${t.author.id}`:t.author.url||"",y={type:t.type,template:t.template||"clean",pm:t.pm,repo:{org:t.repo.org||"",name:t.repo.name,version:t.repo.version,desc:t.repo.desc||`A ${t.type} space`,kw:t.repo.kw||[],license:t.repo.license||"MIT",issues:h,homepage:m,git_url:n},author:{id:t.author.id||"",name:t.author.name||"",email:t.author.email||"",url:p},createdAt:new Date().toISOString()},k=P.format(y,{keyOrder:J});g.writeFileSync(s,k+`
`,"utf-8");}async safeDeleteDirectory(e,t=3){for(let s=0;s<t;s++)try{if(g.rmSync(e,{recursive:!0,force:!0,maxRetries:3,retryDelay:100}),!g.existsSync(e))return}catch(r){if(s===t-1)throw r;await new Promise(a=>setTimeout(a,300*(s+1)));}}};var O=class{constructor(){this.DEFAULT_SCRIPTS={build:"tsup",test:"test",lint:"eslint src --ext .ts"};}install(e,t){let s=[];t?.global?(s.push("install","--global"),e&&e.length>0?s.push(...e):(console.error("\u2718 Please specify packages to install globally"),process.exit(1))):(s.push("install"),e&&e.length>0&&s.push(...e),t?.dev&&s.push("--dev")),console.log(`\u2192 Installing${e?` ${e.join(", ")}`:" dependencies"}${t?.global?" globally":""}...`),this.execute(s),t?.global||this.format();}remove(e,t){let s=["remove"];t?.global&&s.push("--global"),s.push(...e),console.log(`\u{1F5D1}\uFE0F Removing ${e.join(", ")}${t?.global?" globally":""}...`),this.execute(s),t?.global||this.format();}link(e){if(e){let t=Array.isArray(e)?e:[e],s=t.join(", ");console.log(`\u{1F517} Linking global package${t.length>1?"s":""} "${s}" to current project...`),this.execute(["link",...t]);}else console.log("\u{1F517} Linking current package globally..."),this.execute(["link"]);}unlink(e){if(e){let t=Array.isArray(e)?e:[e],s=t.join(", ");console.log(`\u{1F513} Unlinking global package${t.length>1?"s":""} "${s}" from current project...`),this.execute(["unlink",...t]);}else console.log("\u{1F513} Unlinking current package globally..."),this.execute(["unlink"]);}run(e,t){let s=this.getScriptCommand(e);if(s||(console.error(`\u2718 Script "${e}" not found in package.json and no default available`),process.exit(1)),this.isUsingDefaultScript(e)){let a=[...s.split(" ")];t&&t.length>0&&a.push(...t),this.execute(a);}else {let r=["run",e];t&&t.length>0&&r.push("--",...t),this.execute(r);}}runSilent(e,t){let s=this.getScriptCommand(e);if(!s)throw new Error(`Script "${e}" not found in package.json and no default available`);if(this.isUsingDefaultScript(e)){let a=[...s.split(" ")];t&&t.length>0&&a.push(...t),this.executeSilent(a);}else {let r=["run",e];t&&t.length>0&&r.push("--",...t),this.executeSilent(r);}}update(e){console.log(`\u{1F504} Updating${e?` ${e.join(", ")}`:" all packages"}...`);let t=["update"];e&&e.length>0&&t.push(...e),this.execute(t),this.format();}list(e){let t=["pm","ls"];e?.global&&t.push("--global"),this.execute(t);}init(){console.log("\u{1F4DD} Initializing package.json..."),this.execute(["init","-y"]),this.format();}publish(e,t){let s=["publish"];e?.tag&&s.push("--tag",e.tag);let r=e?.access||"public";s.push("--access",r),t&&t.stop(""),Bun.spawnSync(["bun",...s],{stdout:"inherit",stderr:"inherit",stdin:"inherit"}).exitCode===0?console.log("\u2714 Published successfully!"):(console.error("\u2718 Publish failed!"),process.exit(1));}execute(e){Bun.spawnSync(["bun",...e],{stdout:"inherit",stderr:"inherit"}).exitCode!==0&&(console.error(`\u2718 Command failed: bun ${e.join(" ")}`),process.exit(1));}executeSilent(e){let t=Bun.spawnSync(["bun",...e],{stdout:"pipe",stderr:"pipe"});if(t.exitCode!==0){let s=new TextDecoder().decode(t.stderr);console.error(`\u2718 Command failed: bun ${e.join(" ")}`),s&&console.error(s),process.exit(1);}}getName(){return "bun"}getEmoji(){return "\u{1F95F}"}format(){try{let e=T.join(process.cwd(),"package.json");g.existsSync(e)&&P.formatFile(e,{keyOrder:R});}catch{}}getScriptCommand(e){let t=T.join(process.cwd(),"package.json");if(g.existsSync(t))try{let s=JSON.parse(g.readFileSync(t,"utf-8"));if(s.scripts&&s.scripts[e])return s.scripts[e]}catch{}return e in this.DEFAULT_SCRIPTS?this.DEFAULT_SCRIPTS[e]:null}isUsingDefaultScript(e){let t=T.join(process.cwd(),"package.json");if(g.existsSync(t))try{let s=JSON.parse(g.readFileSync(t,"utf-8"));if(s.scripts&&s.scripts[e])return !1}catch{}return e in this.DEFAULT_SCRIPTS}};j();var l=class{static async promptInit(e){let t=e.name,s=e.type,r=e.template,a=e.desc,i="";if((!t||t==="my-space")&&(t=await input({message:"name:",default:"my-space",validate:o=>{if(!o||o.trim()==="")return "Space name is required";let d=/^@([a-z0-9-_]+)\/([a-z0-9-_]+)$/,c=/^[a-z0-9-_]+$/;return !d.test(o)&&!c.test(o)?'Name must be either "package-name" or "@org/package-name" (lowercase, numbers, hyphens, underscores only)':true}})),!s){let o=b.getTemplatesForType("lib",false).length>0,d=b.getTemplatesForType("cli",false).length>0,c=b.getTemplatesForType("server",false).length>0,f=b.getTemplatesForType("app",false).length>0;s=await select({message:"type:",choices:[{name:`\u2192 Library    - TypeScript library for npm${o?"":" (Coming Soon)"}`,value:"lib",disabled:o?false:"No templates ready yet"},{name:`\u2192 CLI        - Command-line tool${d?"":" (Coming Soon)"}`,value:"cli",disabled:d?false:"No templates ready yet"},{name:`\u2192 Server     - Backend server application${c?"":" (Coming Soon)"}`,value:"server",disabled:c?false:"No templates ready yet"},{name:`\u2192 Web App    - Full-stack web application${f?"":" (Coming Soon)"}`,value:"web",disabled:f?false:"No templates ready yet"}]});}if(!r){let o=b.getTemplatesForType(s,true);if(o.filter(f=>f.ready).length===0)throw new Error(`No templates are ready yet for "${s}" spaces. This space type is coming soon!`);let c=o.map(f=>{let C=f.ready?"\u2714":"\u{1F6A7}",_=f.ready?"":" (Coming Soon)";return {name:`${C} ${f.label}${_} - ${f.description}`,value:f.name,short:f.label,disabled:f.ready?false:"Not ready yet"}});r=await select({message:"template:",choices:c,default:b.getDefaultTemplate(s)});}a||(a=await input({message:"desc:",default:s==="lib"?"A TypeScript library":s==="cli"?"A command-line tool":"A backend server"}));let n="bun";i=await input({message:"author name:",default:""});let m=await input({message:"author email:",default:"",validate:o=>o&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)?"Please enter a valid email address or leave empty":true}),h=await input({message:"github username:",default:"",validate:o=>o&&!/^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/i.test(o)?"Please enter a valid GitHub username or leave empty":true}),p=await input({message:"keywords (comma-separated):",default:""}),y=p?p.split(",").map(o=>o.trim()).filter(o=>o):[],k=await input({message:"license:",default:"MIT"});return {name:t,type:s,template:r,description:a,packageManager:n,author:i,authorEmail:m,githubId:h,keywords:y,license:k}}static async promptPublish(e){if(!await confirm({message:`Are you sure you want to publish "${e}" to npm?`,default:false}))return {confirm:false};let s=await input({message:"Publish with a tag (e.g., beta, next) or leave empty for latest:",default:""}),r=await select({message:"\u{1F510} Access level:",choices:[{name:"Public - Anyone can install",value:"public"},{name:"Restricted - Requires authentication",value:"restricted"}],default:"public"});return {confirm:true,tag:s||void 0,access:r}}static async promptRemove(e){let t=await confirm({message:`Remove ${e.join(", ")}?`,default:true});return {packages:e,confirm:t}}static async promptConfirm(e,t=false){let r=(await import('readline')).createInterface({input:process.stdin,output:process.stdout}),a=t?" (Y/n)":" (y/N)";return new Promise(i=>{r.question(`${e}${a} `,n=>{r.close(),n.trim()===""?i(t):i(n.trim().toLowerCase()==="y"||n.trim().toLowerCase()==="yes");});})}static async promptInstall(e){let t=await input({message:"Enter package names (space-separated):",default:e||"",validate:r=>!r||r.trim()===""?"Please enter at least one package name":true}),s=await confirm({message:"\u{1F6E0}\uFE0F  Install as dev dependency?",default:false});return {packages:t.split(" ").filter(r=>r.trim()),isDev:s}}static async promptUpdate(){return await select({message:"What do you want to update?",choices:[{name:"All packages",value:"all"},{name:"Specific packages",value:"specific"}]})==="all"?{updateAll:true}:{updateAll:false,packages:(await input({message:"\u{1F4E6} Enter package names (space-separated):",validate:s=>!s||s.trim()===""?"Please enter at least one package name":true})).split(" ").filter(s=>s.trim())}}static async promptUseCurrentDir(e){return await confirm({message:`Use current directory "${e}" as the space root?`,default:true})}static async promptDeleteExistingDir(e){return await confirm({message:`\u26A0\uFE0F  Directory already exists at "${e}". Delete and recreate?`,default:false})}static showSuccess(e,t){console.log(""),t.forEach(s=>{console.log(`\u2192 ${s}`);}),console.log("");}static showError(e,t){console.log(`
\u2718 Error:`,e),t&&t.message&&console.log(`   ${t.message}`),console.log("");}static showWarning(e){console.log(`
\u26A0\uFE0F  Warning:`,e),console.log("");}static showInfo(e){console.log(`
\u2139\uFE0F  `,e),console.log("");}};var E=class{constructor(){this.frames=["\u280B","\u2819","\u2839","\u2838","\u283C","\u2834","\u2826","\u2827","\u2807","\u280F"];this.currentFrame=0;this.interval=null;}start(e){process.stdout.write(`
${e}`),this.interval=setInterval(()=>{process.stdout.write(`\r${this.frames[this.currentFrame]} ${e}`),this.currentFrame=(this.currentFrame+1)%this.frames.length;},80);}stop(e){this.interval&&(clearInterval(this.interval),this.interval=null),e===""?process.stdout.write("\r\x1B[K\x1B[1A\x1B[K"):process.stdout.write(`\r${e}                          

`);}stopWithError(e){this.interval&&(clearInterval(this.interval),this.interval=null),process.stdout.write(`\r\u2718 ${e}                          

`);}};var M=class u{constructor(e){this.config=e;this.pm=null;this.spaceManager=new F,this.initPackageManager();}static create(e){return new u(e)}run(){cli(this.config.name,this.config.version).description(this.config.desc).command({name:"init",description:"Create a new space (lib or cli)",args:[{name:"name",required:false,default:"my-space",description:"Name of the space (supports @org/name format)"}],options:[{name:"type",flag:"-t",type:"string",required:false,description:"Type of space (lib or cli)"},{name:"description",flag:"--desc",type:"string",required:false,description:"Description of the space"}],action:e=>this.createNewSpaceOnGroundViaCLI(e)}).command({name:"lint",description:"Run linter for the current space",options:[{name:"fix",flag:"--fix",type:"boolean",required:false,description:"Automatically fix linting issues"}],action:e=>this.runLint(e)}).command({name:"info",description:"Show current space information",action:()=>this.showSpaceInfo()}).command({name:"install",aliases:["i"],description:"Install packages",allowDynamicArgs:true,args:[{name:"packages",required:false,description:"Packages to install (space-separated)"}],options:[{name:"dev",flag:"--dev",type:"boolean",required:false,description:"Install as dev dependency"},{name:"global",flag:"--global",type:"boolean",required:false,description:"Install globally"}],action:e=>this.installPackages(e)}).command({name:"remove",aliases:["r"],description:"Remove packages",allowDynamicArgs:true,args:[{name:"packages",required:true,description:"Packages to remove (space-separated)"}],options:[{name:"global",flag:"--global",type:"boolean",required:false,description:"Remove globally"}],action:e=>this.removePackages(e)}).command({name:"update",aliases:["up"],description:"Update packages",allowDynamicArgs:true,args:[{name:"packages",required:false,description:"Packages to update (space-separated, or all if empty)"}],action:e=>this.updatePackages(e)}).command({name:"link",description:"Link package globally (no args) or link global package(s) to project (with package name(s))",allowDynamicArgs:true,args:[{name:"package",required:false,description:"Package name(s) to link from global (optional, supports multiple)"}],action:e=>this.linkPackage(e)}).command({name:"unlink",description:"Unlink package globally (no args) or unlink global package(s) from project (with package name(s))",allowDynamicArgs:true,args:[{name:"package",required:false,description:"Package name(s) to unlink from global (optional, supports multiple)"}],action:e=>this.unlinkPackage(e)}).command({name:"list",aliases:["ls"],description:"List installed packages",options:[{name:"global",flag:"--global",type:"boolean",required:false,description:"List global packages"}],action:e=>this.listPackages(e)}).command({name:"build",description:"Build the current space",action:()=>this.buildSpace()}).command({name:"test",description:"Run tests for the current space",args:[{name:"path",required:false,description:"Specific test file or folder (optional)"}],options:[{name:"coverage",flag:"--coverage",type:"boolean",required:false,description:"Generate code coverage report"},{name:"watch",flag:"--watch",type:"boolean",required:false,description:"Run tests in watch mode"},{name:"bail",flag:"--bail",type:"boolean",required:false,description:"Exit on first test failure"},{name:"timeout",flag:"--timeout",type:"string",required:false,description:"Set test timeout in milliseconds"},{name:"rerun-each",flag:"--rerun-each",type:"string",required:false,description:"Re-run each test N times"},{name:"concurrent",flag:"--concurrent",type:"boolean",required:false,description:"Run tests concurrently"},{name:"coverage-reporter",flag:"--coverage-reporter",type:"string",required:false,description:"Coverage reporter format (text, lcov, etc.)"},{name:"test-name-pattern",flag:"-t",type:"string",required:false,description:"Filter tests by name pattern"}],action:e=>this.runTests(e)}).command({name:"run",description:"Run any script from package.json",args:[{name:"script",required:true,description:"Script name from package.json"}],allowDynamicArgs:true,allowDynamicOptions:true,action:e=>this.runScript(e)}).command({name:"clean",description:"Clean build artifacts",action:()=>this.clean()}).command({name:"start",description:"Start the main file",allowDynamicArgs:true,allowDynamicOptions:true,action:e=>this.startMain(e)}).command({name:"publish",description:"Publish space to npm registry",options:[{name:"tag",flag:"--tag",type:"string",required:false,description:"Publish with tag (e.g., beta, next)"},{name:"access",flag:"--access",type:"string",required:false,description:"Access level (public or restricted)"}],action:e=>this.publish(e)}).build().run();}static defaultConfig(){return {name:"Space",version:"0.0.1",desc:"Build flexible spaces for any platform"}}initPackageManager(){this.spaceManager.isSpace()&&(this.pm=new O);}ensureSpace(){return this.spaceManager.isSpace()?true:(console.error('\u2718 Not a space directory. Run "space init <name> -t lib|cli" first.'),false)}parsePackageName(e){let t=/^@([a-z0-9-_]+)\/([a-z0-9-_]+)$/i,s=e.match(t);return s?{org:s[1],name:s[2]}:{org:"",name:e}}async deleteDirectoryWithRetry(e,t=3){for(let s=0;s<t;s++)try{if(g.rmSync(e,{recursive:!0,force:!0,maxRetries:3,retryDelay:100}),!g.existsSync(e))return}catch(r){if(s===t-1)throw r;await new Promise(a=>setTimeout(a,500*(s+1)));}throw new Error("Failed to delete directory after multiple attempts")}async createNewSpaceOnGroundViaCLI(e){try{let t=await l.promptInit({type:e.options.type,template:e.options.template,org:"",name:e.args.name,desc:e.options.desc}),{org:s,name:r}=this.parsePackageName(t.name);["lib","cli","server","web"].includes(t.type)||(l.showError("Invalid space type. Must be lib, cli, server or web."),process.exit(1));let{TemplateRegistry:a}=await Promise.resolve().then(()=>(j(),q));a.isValidTemplate(t.type,t.template)||(l.showError("Invalid template for this space type."),process.exit(1)),a.isTemplateReady(t.type,t.template)||(l.showError("This template is not ready yet. Please choose another template."),process.exit(1));let i,n=T.basename(process.cwd());if(!r||r.trim()===""?await l.promptUseCurrentDir(n)?i=process.cwd():(l.showError("Space name is required when not using current directory"),process.exit(1)):n===r&&await l.promptUseCurrentDir(r)&&(i=process.cwd()),i||(i=T.join(process.cwd(),r)),g.existsSync(i)){g.statSync(i).isDirectory()||(l.showError(`Path "${i}" exists but is not a directory`),process.exit(1)),await l.promptDeleteExistingDir(i)||(l.showInfo("Space creation cancelled"),process.exit(0));try{await this.deleteDirectoryWithRetry(i);}catch(p){p instanceof Error?p.message&&(p.message.includes("EBUSY")||p.message.includes("EPERM")||p.message.includes("resource busy"))?l.showError(`Cannot delete directory - it's being used by another program.

Please try:
  1. Close any terminals/editors with "${i}" open
  2. Navigate out of the directory in all terminals
  3. Run PowerShell/Terminal as Administrator
  4. Wait a few seconds and try again`):l.showError("Failed to delete existing directory.",p):l.showError("Failed to delete existing directory.",new Error("Unknown error")),process.exit(1);}}await this.spaceManager.createSpace({type:t.type,template:t.template,pm:"bun",repo:{org:s,name:r,version:"0.0.1",desc:t.description,kw:t.keywords.length>0?t.keywords:[],license:t.license||"MIT"},author:{id:t.githubId,name:t.author,email:t.authorEmail,url:""},createdAt:new Date().toISOString()},i),l.showSuccess(r,[i===process.cwd()?"space install":`cd ${r}`,"space install","space build"]);}catch(t){l.showError("Failed to create space",t),process.exit(1);}}showSpaceInfo(){if(!this.ensureSpace())return;let e=this.spaceManager.loadSpaceConfig();if(!e){console.error("\u2718 Could not load space configuration.");return}console.log("");let s=e.repo?.org&&e.repo.org.trim()!==""?`${e.repo.org}/${e.repo.name}`:e.repo.name;if(console.log(`Name:            ${s}`),console.log(`Type:            ${e.type}`),console.log(`Version:         ${e.repo.version}`),e.repo.desc&&e.repo.desc!=="{{desc}}"&&e.repo.desc!=="{{description}}"&&console.log(`Description:     ${e.repo.desc}`),e.repo.kw){let r=[];if(Array.isArray(e.repo.kw))r=e.repo.kw.filter(a=>a&&typeof a=="string"&&a.trim()!==""&&a!=="{{kw}}"&&a!=="{{keywords}}");else if(typeof e.repo.kw=="string"){let a=e.repo.kw;a!=="{{kw}}"&&a!=="{{keywords}}"&&a.trim()!==""&&(r=a.split(",").map(i=>i.trim()).filter(i=>i!==""));}r.length>0&&console.log(`Keywords:        ${r.join(", ")}`);}e.repo.license&&e.repo.license!=="{{license}}"&&console.log(`License:         ${e.repo.license}`),console.log("PackageManager:  bun"),e.author?.name&&e.author.name!=="{{author}}"&&e.author.name!=="{{author_name}}"&&console.log(`Author:          ${e.author.name}`),console.log(`Created:         ${new Date(e.createdAt).toLocaleDateString()}`),console.log("");}runLint(e){if(!this.ensureSpace())return;this.pm||this.initPackageManager();let t=[];e?.options?.fix&&t.push("--fix"),t.length>0?this.pm.run("lint",t):this.pm.run("lint");}async installPackages(e){if(this.ensureSpace()){this.pm||this.initPackageManager();try{let t=[];if(e.args?.packages){let r=e.args.packages.split(" ").filter(a=>a.trim());t.push(...r);}e?.dynamicArgs&&Array.isArray(e.dynamicArgs)&&t.push(...e.dynamicArgs);let s=e.options?.dev||!1;if(t.length===0&&!await l.promptConfirm("No packages specified. Install all dependencies from package.json?",!0)){let a=await l.promptInstall();t=a.packages,s=a.isDev;}this.pm.install(t.length>0?t:void 0,{dev:s,global:e.options?.global});}catch(t){l.showError("\u2718 Installation failed",t),process.exit(1);}}}async removePackages(e){if(this.ensureSpace()){this.pm||this.initPackageManager();try{let t=[];if(e.args?.packages){let r=e.args.packages.split(" ").filter(a=>a.trim());t.push(...r);}if(e?.dynamicArgs&&Array.isArray(e.dynamicArgs)&&t.push(...e.dynamicArgs),t.length===0){l.showError("Please specify packages to remove");return}if(!(await l.promptRemove(t)).confirm){l.showInfo("Removal cancelled");return}this.pm.remove(t,{global:e.options?.global});}catch(t){l.showError("\u2718 Removal failed",t),process.exit(1);}}}async updatePackages(e){if(this.ensureSpace()){this.pm||this.initPackageManager();try{let t;if(e.args?.packages){let s=e.args.packages.split(" ").filter(r=>r.trim());t=s.length>0?s:void 0;}if(e?.dynamicArgs&&Array.isArray(e.dynamicArgs)&&(t||(t=[]),t.push(...e.dynamicArgs)),!t||t.length===0){let s=await l.promptUpdate();t=s.updateAll?void 0:s.packages;}this.pm.update(t);}catch(t){l.showError("\u2718 Update failed",t),process.exit(1);}}}linkPackage(e){if(!this.ensureSpace())return;this.pm||this.initPackageManager();let t=[];e?.args?.package&&(typeof e.args.package=="string"?t.push(e.args.package):Array.isArray(e.args.package)&&t.push(...e.args.package)),e?.dynamicArgs&&Array.isArray(e.dynamicArgs)&&t.push(...e.dynamicArgs),this.pm.link(t.length>0?t:void 0);}unlinkPackage(e){if(!this.ensureSpace())return;this.pm||this.initPackageManager();let t=[];e?.args?.package&&(typeof e.args.package=="string"?t.push(e.args.package):Array.isArray(e.args.package)&&t.push(...e.args.package)),e?.dynamicArgs&&Array.isArray(e.dynamicArgs)&&t.push(...e.dynamicArgs),this.pm.unlink(t.length>0?t:void 0);}listPackages(e){this.ensureSpace()&&(this.pm||this.initPackageManager(),this.pm.list({global:e.options?.global??false}));}runScript(e){if(!this.ensureSpace())return;this.pm||this.initPackageManager();let t=e?.args?.script;if(!t){l.showError("Please specify a script name");return}try{let s=[];if(e?.dynamicArgs&&Array.isArray(e.dynamicArgs)&&s.push(...e.dynamicArgs),e?.dynamicOptions&&typeof e.dynamicOptions=="object")for(let[r,a]of Object.entries(e.dynamicOptions))s.push(`--${r}`),a!==!0&&a!==!1&&s.push(String(a));this.pm.run(t,s.length>0?s:void 0);}catch(s){l.showError(`Failed to run script "${t}"`,s),process.exit(1);}}buildSpace(e){if(!this.ensureSpace())return;this.pm||this.initPackageManager();let t=new E;t.start("Building space...");try{this.pm.runSilent("build"),t.stop(e?"":"\u2714 Build succeeded");}catch{t.stopWithError("\u2718 Build failed"),process.exit(1);}}buildSpaceBool(e){if(!this.ensureSpace())return  false;this.pm||this.initPackageManager();let t=new E;t.start("Building space...");try{return this.pm.runSilent("build"),t.stop(e?"":"\u2714 Build succeeded"),!0}catch{return t.stopWithError("\u2718 Build failed!"),false}}runTests(e){if(!this.ensureSpace())return;this.pm||this.initPackageManager();let t=[],s=e?.args?.path;s&&t.push(s),e?.options?.coverage&&t.push("--coverage"),e?.options?.["coverage-reporter"]&&t.push("--coverage-reporter",e.options["coverage-reporter"]),e?.options?.watch&&t.push("--watch"),e?.options?.bail&&t.push("--bail"),e?.options?.timeout&&t.push("--timeout",e.options.timeout),e?.options?.["rerun-each"]&&t.push("--rerun-each",e.options["rerun-each"]),e?.options?.concurrent&&t.push("--concurrent"),e?.options?.["test-name-pattern"]&&t.push("-t",e.options["test-name-pattern"]),t.length>0?this.pm.run("test",t):this.pm.run("test");}clean(){if(!this.ensureSpace())return;this.pm||this.initPackageManager();let e=new E;e.start("Cleaning build artifacts...");try{this.pm.run("clean"),e.stop("\u2714 Clean complete!");}catch{e.stopWithError("\u2718 Clean failed!"),process.exit(1);}}startMain(e){if(this.buildSpaceBool(true))try{let t=this.findBuiltMainFile();t||(l.showError(`Could not find built entry point.
Expected to find dist/main.js or dist/index.js after build.`),process.exit(1));let s=[];if(e?.dynamicArgs&&Array.isArray(e.dynamicArgs)&&s.push(...e.dynamicArgs),e?.dynamicOptions&&typeof e.dynamicOptions=="object")for(let[a,i]of Object.entries(e.dynamicOptions))s.push(`--${a}`),i!==!0&&i!==!1&&s.push(String(i));s.length>0;let r=spawnSync("bun",[t,...s],{stdio:"inherit",cwd:process.cwd()});r.error&&(l.showError("Failed to start process",r.error),process.exit(1)),r.status!==0&&r.status!==null&&(console.error(`
\u2718 Process exited with error`),process.exit(r.status));}catch(t){l.showError("Failed to start",t),process.exit(1);}}findBuiltMainFile(){let e=["dist/main.js","dist/index.js","dist/app.js"];for(let t of e)if(g.existsSync(T.join(process.cwd(),t)))return t;try{let t=T.join(process.cwd(),"package.json");if(g.existsSync(t)){let s=JSON.parse(g.readFileSync(t,"utf-8"));if(s.main&&g.existsSync(s.main))return s.main}}catch{}return null}async publish(e){if(this.buildSpaceBool(true))try{let t=this.spaceManager.loadSpaceConfig();if(!t){l.showError("Could not load space configuration");return}let s=t.repo.org?`@${t.repo.org}/${t.repo.name}`:t.repo.name,r=e.options?.tag||void 0,a=e.options?.access||void 0;if(!r&&!a){let n=await l.promptPublish(s);if(!n.confirm){l.showInfo("Publish cancelled");return}r=n.tag,a=n.access;}let i=new E;i.start("Publishing package..."),this.pm.publish({tag:r,access:a},i);}catch(t){l.showError("Publish failed",t),process.exit(1);}}};var Y=M.create({name:"Space",version:"0.0.2",desc:"Build flexible spaces for any platform"});Y.run();//# sourceMappingURL=main.js.map
//# sourceMappingURL=main.js.map